id: rfc5280
version: 1.0

rules:

  # -------------------------------------------------
  # Certificate structure (Section 4.1)
  # -------------------------------------------------

  # Version MUST be 3 when extensions are present
  - id: version-v3-when-extensions
    when:
      target: certificate.extensions
      operator: present
    target: certificate.version
    operator: eq
    operands: [3]
    severity: error

  # Version SHOULD be 2 when UniqueIdentifier present but no extensions
  - id: version-v2-when-unique-id
    when:
      target: certificate.issuerUniqueID
      operator: present
    target: certificate.version
    operator: gte
    operands: [2]
    severity: warning

  - id: version-v2-when-subject-unique-id
    when:
      target: certificate.subjectUniqueID
      operator: present
    target: certificate.version
    operator: gte
    operands: [2]
    severity: warning

  - id: serial-number-present
    target: certificate.serialNumber
    operator: present
    severity: error

  - id: serial-number-positive
    target: certificate.serialNumber.value
    operator: positive
    severity: error

  - id: serial-number-unique
    target: certificate
    operator: serialNumberUnique
    severity: error

  - id: serial-number-length
    target: certificate.serialNumber
    operator: maxLength
    operands: [20]
    severity: error

  - id: signature-algorithm-matches-tbs
    target: certificate
    operator: signatureAlgorithmMatchesTBS
    severity: error

  - id: signature-valid
    target: certificate
    operator: signatureValid
    severity: error


  # -------------------------------------------------
  # Issuer / Subject (Section 4.1.2.4, 4.1.2.6)
  # -------------------------------------------------

  - id: issuer-not-empty
    target: certificate.issuer
    operator: notEmpty
    severity: error

  - id: subject-not-empty-for-ca
    target: certificate.subject
    operator: notEmpty
    appliesTo: [root, intermediate]
    severity: error

  - id: issuer-matches-subject-for-root
    target: certificate
    operator: issuedBy
    appliesTo: [root]
    severity: error


  # -------------------------------------------------
  # Validity (Section 4.1.2.5)
  # -------------------------------------------------

  - id: not-expired
    target: certificate.validity.notAfter
    operator: after
    severity: error

  - id: not-yet-valid
    target: certificate.validity.notBefore
    operator: before
    severity: error

  - id: validity-order-correct
    target: certificate
    operator: validityOrderCorrect
    severity: error


  # -------------------------------------------------
  # Unique Identifiers (Section 4.1.2.8)
  # -------------------------------------------------

  - id: no-unique-identifiers
    target: certificate
    operator: noUniqueIdentifiers
    severity: error


  # -------------------------------------------------
  # Extensions (Section 4.2)
  # -------------------------------------------------

  - id: no-unknown-critical-extensions
    target: certificate
    operator: noUnknownCriticalExtensions
    severity: error


  # -------------------------------------------------
  # Authority Key Identifier (Section 4.2.1.1)
  # -------------------------------------------------

  - id: authority-key-identifier-present
    target: certificate.authorityKeyIdentifier
    operator: present
    appliesTo: [leaf, intermediate]
    severity: warning

  - id: aki-not-critical
    when:
      target: certificate.extensions.2.5.29.35
      operator: present
    target: certificate.extensions.2.5.29.35.critical
    operator: eq
    operands: [false]
    severity: error

  - id: aki-matches-ski
    target: certificate
    operator: akiMatchesSki
    severity: warning


  # -------------------------------------------------
  # Subject Key Identifier (Section 4.2.1.2)
  # -------------------------------------------------

  - id: subject-key-identifier-present
    target: certificate.subjectKeyIdentifier
    operator: present
    appliesTo: [root, intermediate]
    severity: warning

  - id: ski-not-critical
    when:
      target: certificate.extensions.2.5.29.14
      operator: present
    target: certificate.extensions.2.5.29.14.critical
    operator: eq
    operands: [false]
    severity: error


  # -------------------------------------------------
  # Key Usage (Section 4.2.1.3)
  # -------------------------------------------------

  - id: key-usage-present
    target: certificate.keyUsage
    operator: present
    severity: warning

  - id: key-usage-critical-for-ca
    when:
      target: certificate.basicConstraints.cA
      operator: eq
      operands: [true]
    target: certificate.extensions.2.5.29.15.critical
    operator: eq
    operands: [true]
    severity: warning

  - id: ca-key-cert-sign
    target: certificate.keyUsage.keyCertSign
    operator: eq
    operands: [true]
    appliesTo: [root, intermediate]
    severity: error

  - id: leaf-key-usage-valid
    target: certificate
    operator: keyUsageLeaf
    appliesTo: [leaf]
    severity: error


  # -------------------------------------------------
  # Policy Mappings (Section 4.2.1.5)
  # -------------------------------------------------

  - id: policy-mappings-critical
    when:
      target: certificate.extensions.2.5.29.33
      operator: present
    target: certificate.extensions.2.5.29.33.critical
    operator: eq
    operands: [true]
    severity: error


  # -------------------------------------------------
  # Subject Alternative Name (Section 4.2.1.6)
  # -------------------------------------------------

  - id: san-required-if-empty-subject
    target: certificate
    operator: sanRequiredIfEmptySubject
    appliesTo: [leaf]
    severity: error

  - id: san-critical-if-subject-empty
    when:
      target: certificate.subject
      operator: isEmpty
    target: certificate.extensions.2.5.29.17.critical
    operator: eq
    operands: [true]
    severity: error


  # -------------------------------------------------
  # Issuer Alternative Name (Section 4.2.1.7)
  # -------------------------------------------------

  - id: ian-not-critical
    when:
      target: certificate.extensions.2.5.29.18
      operator: present
    target: certificate.extensions.2.5.29.18.critical
    operator: eq
    operands: [false]
    severity: warning


  # -------------------------------------------------
  # Subject Directory Attributes (Section 4.2.1.8)
  # -------------------------------------------------

  - id: subject-directory-attributes-not-critical
    when:
      target: certificate.extensions.2.5.29.9
      operator: present
    target: certificate.extensions.2.5.29.9.critical
    operator: eq
    operands: [false]
    severity: error


  # -------------------------------------------------
  # Basic Constraints (Section 4.2.1.9)
  # -------------------------------------------------

  - id: basic-constraints-present
    target: certificate.basicConstraints
    operator: present
    appliesTo: [root, intermediate]
    severity: error

  - id: basic-constraints-critical-for-ca
    when:
      target: certificate.basicConstraints.cA
      operator: eq
      operands: [true]
    target: certificate.extensions.2.5.29.19.critical
    operator: eq
    operands: [true]
    severity: error

  - id: ca-basic-constraints
    target: certificate.basicConstraints.cA
    operator: eq
    operands: [true]
    appliesTo: [root, intermediate]
    severity: error

  - id: leaf-not-ca
    target: certificate.basicConstraints.cA
    operator: neq
    operands: [true]
    appliesTo: [leaf]
    severity: error

  - id: ca-path-len-valid
    target: certificate
    operator: pathLenValid
    appliesTo: [root, intermediate]
    severity: error


  # -------------------------------------------------
  # Name Constraints (Section 4.2.1.10)
  # -------------------------------------------------

  - id: name-constraints-critical
    when:
      target: certificate.extensions.2.5.29.30
      operator: present
    target: certificate.extensions.2.5.29.30.critical
    operator: eq
    operands: [true]
    severity: error

  - id: name-constraints-valid
    target: certificate
    operator: nameConstraintsValid
    severity: error


  # -------------------------------------------------
  # Certificate Policies (Section 4.2.1.4)
  # -------------------------------------------------

  # Policy validation is use-case dependent - uncomment and specify required policies:
  # - id: certificate-policy-valid
  #   target: certificate
  #   operator: certificatePolicyValid
  #   operands: ["2.5.29.32.0"]  # anyPolicy, or specific policy OIDs
  #   severity: error


  # -------------------------------------------------
  # Policy Constraints (Section 4.2.1.11)
  # -------------------------------------------------

  - id: policy-constraints-critical
    when:
      target: certificate.extensions.2.5.29.36
      operator: present
    target: certificate.extensions.2.5.29.36.critical
    operator: eq
    operands: [true]
    severity: error


  # -------------------------------------------------
  # Inhibit anyPolicy (Section 4.2.1.14)
  # -------------------------------------------------

  - id: inhibit-any-policy-critical
    when:
      target: certificate.extensions.2.5.29.54
      operator: present
    target: certificate.extensions.2.5.29.54.critical
    operator: eq
    operands: [true]
    severity: error


  # -------------------------------------------------
  # Freshest CRL (Section 4.2.1.15)
  # -------------------------------------------------

  - id: freshest-crl-not-critical
    when:
      target: certificate.extensions.2.5.29.46
      operator: present
    target: certificate.extensions.2.5.29.46.critical
    operator: eq
    operands: [false]
    severity: error


  # -------------------------------------------------
  # Authority Information Access (Section 4.2.2.1)
  # -------------------------------------------------

  - id: aia-not-critical
    when:
      target: certificate.extensions.1.3.6.1.5.5.7.1.1
      operator: present
    target: certificate.extensions.1.3.6.1.5.5.7.1.1.critical
    operator: eq
    operands: [false]
    severity: error


  # -------------------------------------------------
  # Subject Information Access (Section 4.2.2.2)
  # -------------------------------------------------

  - id: sia-not-critical
    when:
      target: certificate.extensions.1.3.6.1.5.5.7.1.11
      operator: present
    target: certificate.extensions.1.3.6.1.5.5.7.1.11.critical
    operator: eq
    operands: [false]
    severity: error


  # -------------------------------------------------
  # CRL Profile (Section 5)
  # -------------------------------------------------

  - id: crl-valid
    target: crl
    operator: crlValid
    severity: error

  - id: crl-not-expired
    target: crl
    operator: crlNotExpired
    severity: error

  - id: crl-signed-by
    target: crl
    operator: crlSignedBy
    severity: error

  - id: cert-not-revoked
    target: certificate
    operator: notRevoked
    severity: error

  - id: crl-aki-not-critical
    when:
      target: crl.extensions.2.5.29.35
      operator: present
    target: crl.extensions.2.5.29.35.critical
    operator: eq
    operands: [false]
    severity: error

  - id: crl-number-not-critical
    when:
      target: crl.extensions.2.5.29.20
      operator: present
    target: crl.extensions.2.5.29.20.critical
    operator: eq
    operands: [false]
    severity: error

  - id: crl-delta-indicator-critical
    when:
      target: crl.extensions.2.5.29.27
      operator: present
    target: crl.extensions.2.5.29.27.critical
    operator: eq
    operands: [true]
    severity: error

  - id: crl-idp-critical
    when:
      target: crl.extensions.2.5.29.28
      operator: present
    target: crl.extensions.2.5.29.28.critical
    operator: eq
    operands: [true]
    severity: error


  # -------------------------------------------------
  # OCSP (RFC 6960)
  # -------------------------------------------------

  - id: ocsp-valid
    target: certificate
    operator: ocspValid
    severity: error

  - id: ocsp-not-revoked
    target: certificate
    operator: notRevokedOCSP
    severity: error
