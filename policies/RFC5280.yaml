id: rfc5280
version: 1.0

rules:

  # -------------------------------------------------
  # Certificate structure
  # -------------------------------------------------

  - id: version-v3
    target: certificate.version
    operator: eq
    operands: [3]
    severity: error

  - id: serial-number-present
    target: certificate.serialNumber
    operator: present
    severity: error

  - id: serial-number-positive
    target: certificate.serialNumber.value
    operator: positive
    severity: error

  - id: serial-number-unique
    target: certificate
    operator: serialNumberUnique
    severity: error

  - id: serial-number-length
    target: certificate.serialNumber
    operator: maxLength
    operands: [20]  # 20 bytes = 160 bits
    severity: error

  # -------------------------------------------------
  # Signature algorithm
  # -------------------------------------------------

  - id: signature-algorithm-allowed
    target: certificate.signatureAlgorithm.algorithm
    operator: in
    operands:
      - SHA256-RSA
      - SHA384-RSA
      - SHA512-RSA
      - ECDSA-SHA256
      - ECDSA-SHA384
      - ECDSA-SHA512
      - Ed25519
    severity: error

  - id: signature-algorithm-not-weak
    target: certificate.signatureAlgorithm.algorithm
    operator: notIn
    operands:
      - MD5-RSA
      - SHA1-RSA
      - DSA-SHA1
      - ECDSA-SHA1
    severity: error

  - id: signature-algorithm-matches-tbs
    target: certificate
    operator: signatureAlgorithmMatchesTBS
    severity: error

  - id: signature-valid
    target: certificate
    operator: signedBy
    severity: error


  # -------------------------------------------------
  # Issuer / Subject
  # -------------------------------------------------

  - id: issuer-present
    target: certificate.issuer
    operator: present
    severity: error

  - id: issuer-not-empty
    target: certificate.issuer
    operator: notEmpty
    severity: error

  - id: subject-present
    target: certificate.subject
    operator: present
    severity: warning

  - id: subject-not-empty-for-ca
    target: certificate.subject
    operator: notEmpty
    appliesTo: [root, intermediate]
    severity: error

  - id: issuer-matches-subject-for-root
    target: certificate
    operator: issuedBy
    appliesTo: [root]
    severity: error


  # -------------------------------------------------
  # Validity
  # -------------------------------------------------

  - id: not-expired
    target: certificate.validity.notAfter
    operator: after
    severity: error

  - id: not-yet-valid
    target: certificate.validity.notBefore
    operator: before
    severity: error

  - id: validity-order-correct
    target: certificate
    operator: validityOrderCorrect
    severity: error


  # -------------------------------------------------
  # Public key checks (algorithm-specific)
  # -------------------------------------------------

  ## RSA
  - id: rsa-key-size-minimum
    when:
      target: certificate.subjectPublicKeyInfo.algorithm
      operator: eq
      operands: [RSA]
    target: certificate.subjectPublicKeyInfo.publicKey.keySize
    operator: gte
    operands: [2048]
    severity: error

  - id: rsa-exponent-valid
    when:
      target: certificate.subjectPublicKeyInfo.algorithm
      operator: eq
      operands: [RSA]
    target: certificate.subjectPublicKeyInfo.publicKey.exponent
    operator: odd
    severity: error

  ## ECDSA
  - id: ecdsa-curve-allowed
    when:
      target: certificate.subjectPublicKeyInfo.algorithm
      operator: eq
      operands: [ECDSA]
    target: certificate.subjectPublicKeyInfo.publicKey.curve
    operator: in
    operands:
      - P-256
      - P-384
      - P-521
    severity: error

  ## Ed25519
  - id: ed25519-no-params
    when:
      target: certificate.subjectPublicKeyInfo.algorithm
      operator: eq
      operands: [Ed25519]
    target: certificate.subjectPublicKeyInfo.parameters
    operator: absent
    severity: error


  # -------------------------------------------------
  # Extensions
  # -------------------------------------------------

  - id: basic-constraints-present
    target: certificate.basicConstraints
    operator: present
    severity: warning

  - id: basic-constraints-critical-for-ca
    when:
      target: certificate.basicConstraints.cA
      operator: eq
      operands: [true]
    target: certificate.extensions.2.5.29.19.critical
    operator: eq
    operands: [true]
    severity: error

  - id: key-usage-present
    target: certificate.keyUsage
    operator: present
    severity: warning

  - id: key-usage-critical-for-ca
    when:
      target: certificate.basicConstraints.cA
      operator: eq
      operands: [true]
    target: certificate.extensions.2.5.29.15.critical
    operator: eq
    operands: [true]
    severity: error

  - id: authority-key-identifier-present
    target: certificate.authorityKeyIdentifier
    operator: present
    appliesTo: [leaf, intermediate]
    severity: warning

  - id: subject-key-identifier-present
    target: certificate.subjectKeyIdentifier
    operator: present
    severity: warning

  - id: aki-matches-ski
    target: certificate
    operator: akiMatchesSki
    severity: warning

  - id: no-unknown-critical-extensions
    target: certificate
    operator: noUnknownCriticalExtensions
    severity: error


  # -------------------------------------------------
  # CA semantics
  # -------------------------------------------------

  - id: ca-basic-constraints
    target: certificate.basicConstraints.cA
    operator: eq
    operands: [true]
    appliesTo: [root, intermediate]
    severity: error

  - id: ca-key-cert-sign
    target: certificate.keyUsage.keyCertSign
    operator: eq
    operands: [true]
    appliesTo: [root, intermediate]
    severity: error

  - id: ca-path-len-valid
    target: certificate
    operator: pathLenValid
    appliesTo: [root, intermediate]
    severity: error

  - id: name-constraints-valid
    target: certificate
    operator: nameConstraintsValid
    severity: error


  # -------------------------------------------------
  # Leaf semantics
  # -------------------------------------------------

  - id: leaf-not-ca
    target: certificate.basicConstraints.cA
    operator: neq
    operands: [true]
    appliesTo: [leaf]
    severity: error

  - id: leaf-key-usage-valid
    target: certificate
    operator: keyUsageLeaf
    appliesTo: [leaf]
    severity: error

  - id: san-required-if-empty-subject
    target: certificate
    operator: sanRequiredIfEmptySubject
    appliesTo: [leaf]
    severity: error


  # -------------------------------------------------
  # Prohibited features
  # -------------------------------------------------

  - id: no-unique-identifiers
    target: certificate
    operator: noUniqueIdentifiers
    severity: error


  # -------------------------------------------------
  # Extension criticality requirements
  # -------------------------------------------------

  ## Extensions that MUST NOT be critical (using OID paths)
  # Authority Key Identifier (2.5.29.35)
  - id: aki-not-critical
    when:
      target: certificate.extensions.2.5.29.35
      operator: present
    target: certificate.extensions.2.5.29.35.critical
    operator: eq
    operands: [false]
    severity: error

  # Subject Key Identifier (2.5.29.14)
  - id: ski-not-critical
    when:
      target: certificate.extensions.2.5.29.14
      operator: present
    target: certificate.extensions.2.5.29.14.critical
    operator: eq
    operands: [false]
    severity: error

  # Authority Information Access (1.3.6.1.5.5.7.1.1)
  - id: aia-not-critical
    when:
      target: certificate.extensions.1.3.6.1.5.5.7.1.1
      operator: present
    target: certificate.extensions.1.3.6.1.5.5.7.1.1.critical
    operator: eq
    operands: [false]
    severity: error

  # Subject Information Access (1.3.6.1.5.5.7.1.11)
  - id: sia-not-critical
    when:
      target: certificate.extensions.1.3.6.1.5.5.7.1.11
      operator: present
    target: certificate.extensions.1.3.6.1.5.5.7.1.11.critical
    operator: eq
    operands: [false]
    severity: error

  # Issuer Alternative Name (2.5.29.18)
  - id: ian-not-critical
    when:
      target: certificate.extensions.2.5.29.18
      operator: present
    target: certificate.extensions.2.5.29.18.critical
    operator: eq
    operands: [false]
    severity: warning

  # Freshest CRL (2.5.29.46)
  - id: freshest-crl-not-critical
    when:
      target: certificate.extensions.2.5.29.46
      operator: present
    target: certificate.extensions.2.5.29.46.critical
    operator: eq
    operands: [false]
    severity: error

  # Subject Directory Attributes (2.5.29.9)
  - id: subject-directory-attributes-not-critical
    when:
      target: certificate.extensions.2.5.29.9
      operator: present
    target: certificate.extensions.2.5.29.9.critical
    operator: eq
    operands: [false]
    severity: error

  ## Extensions that MUST be critical when present
  # Policy Mappings (2.5.29.33)
  - id: policy-mappings-critical
    when:
      target: certificate.extensions.2.5.29.33
      operator: present
    target: certificate.extensions.2.5.29.33.critical
    operator: eq
    operands: [true]
    severity: error

  # Name Constraints (2.5.29.30)
  - id: name-constraints-critical
    when:
      target: certificate.extensions.2.5.29.30
      operator: present
    target: certificate.extensions.2.5.29.30.critical
    operator: eq
    operands: [true]
    severity: error

  # Policy Constraints (2.5.29.36)
  - id: policy-constraints-critical
    when:
      target: certificate.extensions.2.5.29.36
      operator: present
    target: certificate.extensions.2.5.29.36.critical
    operator: eq
    operands: [true]
    severity: error

  # Inhibit anyPolicy (2.5.29.54)
  - id: inhibit-any-policy-critical
    when:
      target: certificate.extensions.2.5.29.54
      operator: present
    target: certificate.extensions.2.5.29.54.critical
    operator: eq
    operands: [true]
    severity: error


  # -------------------------------------------------
  # Additional public key checks
  # -------------------------------------------------

  - id: rsa-exponent-recommended
    when:
      target: certificate.subjectPublicKeyInfo.algorithm
      operator: eq
      operands: [RSA]
    target: certificate.subjectPublicKeyInfo.publicKey.exponent
    operator: gte
    operands: [65537]
    severity: warning


  # -------------------------------------------------
  # SAN criticality
  # -------------------------------------------------

  - id: san-critical-if-subject-empty
    when:
      target: certificate.subject
      operator: isEmpty
    target: certificate.extensions.2.5.29.17.critical
    operator: eq
    operands: [true]
    severity: error


  # -------------------------------------------------
  # CRL validation (Section 5)
  # -------------------------------------------------

  ## CRL signature and validity
  - id: crl-valid
    target: crl
    operator: crlValid
    severity: error

  - id: crl-not-expired
    target: crl
    operator: crlNotExpired
    severity: error

  - id: crl-signed-by
    target: crl
    operator: crlSignedBy
    severity: error

  - id: cert-not-revoked
    target: certificate
    operator: notRevoked
    severity: error

  ## OCSP validation (RFC 6960)
  - id: ocsp-valid
    target: certificate
    operator: ocspValid
    severity: error

  - id: ocsp-not-revoked
    target: certificate
    operator: notRevokedOCSP
    severity: error

  ## CRL extension criticality requirements (RFC 5280 Section 5.2)

  # Authority Key Identifier (2.5.29.35) MUST NOT be critical
  - id: crl-aki-not-critical
    when:
      target: crl.extensions.2.5.29.35
      operator: present
    target: crl.extensions.2.5.29.35.critical
    operator: eq
    operands: [false]
    severity: error

  # CRL Number (2.5.29.20) MUST NOT be critical
  - id: crl-number-not-critical
    when:
      target: crl.extensions.2.5.29.20
      operator: present
    target: crl.extensions.2.5.29.20.critical
    operator: eq
    operands: [false]
    severity: error

  # Delta CRL Indicator (2.5.29.27) MUST be critical if present
  - id: crl-delta-indicator-critical
    when:
      target: crl.extensions.2.5.29.27
      operator: present
    target: crl.extensions.2.5.29.27.critical
    operator: eq
    operands: [true]
    severity: error

  # Issuing Distribution Point (2.5.29.28) MUST be critical if present
  - id: crl-idp-critical
    when:
      target: crl.extensions.2.5.29.28
      operator: present
    target: crl.extensions.2.5.29.28.critical
    operator: eq
    operands: [true]
    severity: error